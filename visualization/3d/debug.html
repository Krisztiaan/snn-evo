<!DOCTYPE html>
<html>
<head>
    <title>Visualization Debug Tool</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #333; }
        .good { color: #4caf50; }
        .bad { color: #f44336; }
        button { padding: 10px; margin: 5px; }
        pre { background: #000; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>SNN Visualization Debug Tool</h1>
    
    <div class="section">
        <h2>1. Server Connection</h2>
        <button onclick="testServer()">Test Server</button>
        <div id="server-result"></div>
    </div>
    
    <div class="section">
        <h2>2. Data Loading</h2>
        <button onclick="testDataLoading()">Test Data Loading</button>
        <div id="data-result"></div>
    </div>
    
    <div class="section">
        <h2>3. 3D Scene</h2>
        <button onclick="test3DScene()">Test 3D Scene</button>
        <div id="scene-result"></div>
    </div>
    
    <div class="section">
        <h2>4. Performance</h2>
        <button onclick="testPerformance()">Test Performance</button>
        <div id="perf-result"></div>
    </div>
    
    <script type="module">
        window.testServer = async function() {
            const result = document.getElementById('server-result');
            try {
                const response = await fetch('http://localhost:8080/api/experiments');
                const data = await response.json();
                result.innerHTML = `<span class="good">✓ Server connected</span><br>Found ${data.length} experiments`;
            } catch (e) {
                result.innerHTML = `<span class="bad">✗ Server error: ${e.message}</span>`;
            }
        }
        
        window.testDataLoading = async function() {
            const result = document.getElementById('data-result');
            try {
                // Get experiments
                const expResponse = await fetch('http://localhost:8080/api/experiments');
                const experiments = await expResponse.json();
                
                if (experiments.length === 0) {
                    result.innerHTML = '<span class="bad">✗ No experiments found</span>';
                    return;
                }
                
                // Test loading first experiment
                const exp = experiments[0];
                const trajResponse = await fetch(`http://localhost:8080/api/experiment/${exp.experiment_id}/episode/0/trajectory`);
                const trajData = await trajResponse.json();
                
                result.innerHTML = `
                    <span class="good">✓ Data loading works</span><br>
                    Experiment: ${exp.experiment_id}<br>
                    Trajectory points: ${trajData.trajectory.x.length}<br>
                    Grid size: ${trajData.metadata.grid_size}<br>
                    Total rewards: ${trajData.metadata.total_reward}
                `;
            } catch (e) {
                result.innerHTML = `<span class="bad">✗ Data loading error: ${e.message}</span>`;
            }
        }
        
        window.test3DScene = async function() {
            const result = document.getElementById('scene-result');
            try {
                // Create a minimal 3D scene
                const testDiv = document.createElement('div');
                testDiv.style.width = '400px';
                testDiv.style.height = '300px';
                testDiv.id = 'test-viewport';
                result.appendChild(testDiv);
                
                const { SimpleViewport3D } = await import('./js/simple-viewport.js');
                const viewport = new SimpleViewport3D('test-viewport');
                
                // Test with dummy data
                viewport.setData({
                    trajectory: {
                        x: [0, 1, 2, 3, 4],
                        y: [0, 1, 2, 3, 4]
                    },
                    rewards: [0, 1, 0, 1, 0],
                    metadata: { grid_size: [10, 10] }
                });
                
                let frameCount = 0;
                const startTime = performance.now();
                
                function countFrames() {
                    frameCount++;
                    if (performance.now() - startTime < 1000) {
                        requestAnimationFrame(countFrames);
                    } else {
                        result.innerHTML = `<span class="good">✓ 3D Scene works</span><br>FPS: ${frameCount}`;
                    }
                }
                countFrames();
                
            } catch (e) {
                result.innerHTML = `<span class="bad">✗ 3D Scene error: ${e.message}</span><pre>${e.stack}</pre>`;
            }
        }
        
        window.testPerformance = async function() {
            const result = document.getElementById('perf-result');
            
            // Test various performance metrics
            const metrics = {
                memory: performance.memory ? 
                    `${(performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1)} MB` : 
                    'Not available',
                
                animationFrameTime: await new Promise(resolve => {
                    const times = [];
                    let lastTime = performance.now();
                    let count = 0;
                    
                    function measure() {
                        const now = performance.now();
                        times.push(now - lastTime);
                        lastTime = now;
                        count++;
                        
                        if (count < 60) {
                            requestAnimationFrame(measure);
                        } else {
                            const avg = times.reduce((a,b) => a+b) / times.length;
                            resolve(avg.toFixed(1));
                        }
                    }
                    requestAnimationFrame(measure);
                })
            };
            
            result.innerHTML = `
                <span class="good">Performance Metrics:</span><br>
                Memory usage: ${metrics.memory}<br>
                Avg frame time: ${metrics.animationFrameTime}ms<br>
                Target FPS: ${(1000 / metrics.animationFrameTime).toFixed(0)}
            `;
        }
    </script>
</body>
</html>