<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNN Agent Scientific Visualization</title>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Tippy.js for tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css">
    
    <!-- Performance optimizations -->
    <style>
        /* GPU acceleration */
        #viewport { transform: translateZ(0); will-change: transform; }
        
        /* Performance monitor */
        .performance-monitor {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            z-index: 1000;
        }
        .perf-row { margin: 2px 0; }
        .quality-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
    </style>
    
    <!-- Local dependencies -->
    <script src="js/vendor/three.min.js"></script>
    <script src="js/vendor/OrbitControls.js"></script>
    <script src="js/vendor/chart.umd.min.js"></script>
    <script src="js/vendor/simple-statistics.min.js"></script>
    <script src="js/vendor/msgpack.min.js"></script>
    
    <!-- Alpine components -->
    <script src="js/alpine-stores.js"></script>
    <script src="js/alpine-app.js"></script>
    <script src="js/alpine-tooltips.js"></script>
</head>
<body>
    <div id="app" x-data="app" x-init="init()"
         @keydown.space.window.prevent="togglePlayback()"
         @keydown.left.window="step(-100)"
         @keydown.right.window="step(100)"
         @keydown.r.window="modules.viewport?.resetCamera()"
         @keydown.p.window="ui.showPerformance = !ui.showPerformance"
         @keydown.q.window="ui.quality = ui.quality === 'high' ? 'low' : ui.quality === 'medium' ? 'high' : 'medium'"
         @load-episode.window="loadEpisode($event.detail.id)">
        
        <!-- Performance Monitor -->
        <div class="performance-monitor" x-show="ui.showPerformance" x-data="performanceMonitor">
            <div class="perf-row">
                <span class="quality-indicator" :style="`background: ${qualityColor}`"></span>
                <span x-text="displayFPS"></span>
            </div>
            <div class="perf-row">Frame: <span x-text="displayFrameTime"></span></div>
            <div class="perf-row">Quality: <span x-text="ui.quality"></span></div>
        </div>
        
        <!-- Header -->
        <header class="header">
            <h1>SNN Agent Visualization</h1>
            <select x-model="data.currentExperiment" @change="loadExperiment()" 
                    :disabled="ui.loading">
                <option value="">Select Experiment...</option>
                <template x-for="exp in data.experiments" :key="exp.experiment_id">
                    <option :value="exp.experiment_id" 
                            x-text="`${exp.experiment_id} (${exp.num_episodes} episodes)`">
                    </option>
                </template>
            </select>
            <button @click="togglePlayback()" 
                    :disabled="!data.episodeData"
                    x-text="playback.playing ? '⏸ Pause' : '▶ Play'"
                    x-tooltip="'Space bar to toggle'">
            </button>
            <button @click="exportData()" 
                    :disabled="!data.episodeData"
                    x-tooltip="'Export current episode data'">
                Export Data
            </button>
            <div style="margin-left: auto; display: flex; gap: 1rem; align-items: center;">
                <label class="text-small">
                    Speed:
                    <select x-model="playback.speed">
                        <option value="0.5">0.5x</option>
                        <option value="1">1x</option>
                        <option value="2">2x</option>
                        <option value="5">5x</option>
                    </select>
                </label>
                <label class="text-small">
                    Quality:
                    <select x-model="ui.quality">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </label>
                <button @click="ui.showPerformance = !ui.showPerformance" 
                        x-text="ui.showPerformance ? 'Hide Perf' : 'Show Perf'"
                        x-tooltip="'Press P to toggle'">
                </button>
            </div>
        </header>
        
        <!-- Main content -->
        <div class="main-content">
            <!-- Left panel: Episode list and stats -->
            <aside class="panel" id="left-panel">
                <h2>Episodes</h2>
                <div id="episode-list" x-data="episodes">
                    <template x-for="episode in data.episodes" :key="episode.episode_id">
                        <div class="episode-item" 
                             @click="selectEpisode(episode.episode_id)"
                             :class="{'selected': data.currentEpisode === episode.episode_id}">
                            <div style="font-weight: 500;" x-text="`Episode ${episode.episode_id}`"></div>
                            <div class="text-small text-muted" style="margin-top: 0.2rem;">
                                <span x-text="`Reward: ${episode.total_reward.toFixed(1)}`"></span> |
                                <span x-text="`Length: ${episode.episode_length}`"></span>
                            </div>
                        </div>
                    </template>
                </div>
                
                <h2 style="margin-top: 2rem;">Statistics</h2>
                <div class="stat-card">
                    <div class="stat-label">Total Reward</div>
                    <div class="stat-value" x-text="stats.totalReward"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Episode Length</div>
                    <div class="stat-value" x-text="stats.episodeLength"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Firing Rate</div>
                    <div class="stat-value" x-text="stats.firingRate"></div>
                </div>
            </aside>
            
            <!-- Center: 3D viewport -->
            <main id="viewport">
                <div class="loading-overlay" x-show="ui.loading" x-transition>
                    <div class="loading-spinner"></div>
                </div>
                
                <!-- Camera controls -->
                <div class="camera-controls">
                    <label>
                        <input type="checkbox" x-model="ui.cameraFollow">
                        Follow Agent
                    </label>
                </div>
                
                <!-- Timeline controls -->
                <div class="timeline-container" x-data="timeline">
                    <div class="timeline-controls">
                        <span x-text="utils.formatTime(playback.time)">0:00</span>
                        <input type="range" 
                               class="timeline-range"
                               x-model="playback.time"
                               :max="playback.duration">
                        <span x-text="utils.formatTime(playback.duration)">0:00</span>
                    </div>
                    <div class="timeline-heatmap" 
                         style="background: linear-gradient(to right, #1a1a1a 0%, #4a9eff 50%, #1a1a1a 100%)"></div>
                </div>
                
                <!-- Tooltips are now handled by Tippy.js -->
            </main>
            
            <!-- Right panel: Neural data and analytics -->
            <aside class="panel" id="right-panel">
                <h2>Neural Activity</h2>
                <div class="neural-viewer" id="neural-viewer">
                    <canvas id="spike-raster"></canvas>
                </div>
                
                <h2 style="margin-top: 1rem;">Performance Metrics</h2>
                <div class="chart-container">
                    <canvas id="reward-chart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="value-chart"></canvas>
                </div>
                
                <h2 style="margin-top: 1rem;">Experiment Info</h2>
                <div class="info-card" x-show="data.currentExperiment">
                    <div class="info-row">
                        <span class="info-label">Experiment:</span>
                        <span x-text="data.currentExperiment"></span>
                    </div>
                    <div class="info-row" x-show="data.episodes.length">
                        <span class="info-label">Episodes:</span>
                        <span x-text="data.episodes.length"></span>
                    </div>
                    <div class="info-row" x-show="data.currentEpisode">
                        <span class="info-label">Current:</span>
                        <span x-text="`Episode ${data.currentEpisode}`"></span>
                    </div>
                </div>
            </aside>
        </div>
    </div>
    
    <!-- Load polyfills and modules -->
    <script src="js/polyfills.js"></script>
    
    
    <script type="module" src="js/app.js"></script>
</body>
</html>